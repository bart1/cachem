<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cache R Objects with Automatic Pruning • cachem</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="Cache R Objects with Automatic Pruning">
<meta property="og:description" content="Key-value stores with automatic pruning. Caches can limit
    either their total size or the age of the oldest object (or both),
    automatically pruning objects to maintain the constraints.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">cachem</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.0.7.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="reference/index.html">Reference</a>
</li>
<li>
  <a href="news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/r-lib/cachem/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">

<ul><li>
<a href="#cachem">cachem</a><ul>
<li><a href="#installation">Installation</a></li>
<li><a href="#usage">Usage</a></li>
<li>
<a href="#cache-types">Cache types</a><ul>
<li><a href="#cache_mem"><code>cache_mem()</code></a></li>
<li><a href="#cache_disk"><code>cache_disk()</code></a></li>
</ul>
</li>
<li><a href="#cache-api">Cache API</a></li>
<li><a href="#pruning">Pruning</a></li>
<li><a href="#layered-caches">Layered caches</a></li>
</ul>
</li></ul>
<!-- README.md is generated from README.Rmd. Please edit that file --><div class="section level1">
<div class="page-header"><h1 id="cachem">cachem<a class="anchor" aria-label="anchor" href="#cachem"></a>
</h1></div>
<!-- badges: start -->
<p>The <strong>cachem</strong> R package provides objects creating and managing caches. These cache objects are key-value stores, but unlike other basic key-value stores, they have built-in support for memory and age limits so that they won’t have unbounded growth.</p>
<p>The cache objects in <strong>cachem</strong> differ from some other key-value stores in the following ways:</p>
<ul>
<li>The cache objects provide automatic pruning so that they remain within memory limits.</li>
<li>Fetching a non-existing object returns a sentinel value. An alternative is to simply return <code>NULL</code>. This is what R lists and environments do, but it is ambiguous whether the value really is <code>NULL</code>, or if it is not present. Another alternative is to throw an exception when fetching a non-existent object. However, this results in more complicated code, as every <code><a href="https://rdrr.io/r/base/get.html" class="external-link">get()</a></code> needs to be wrapped in a <code><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch()</a></code>.</li>
</ul>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>To install the CRAN version:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"cachem"</span><span class="op">)</span></span></code></pre></div>
<p>You can install the development version from with:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="st"><a href="https://remotes.r-lib.org" class="external-link">"remotes"</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"remotes"</span><span class="op">)</span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"r-lib/cachem"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="usage">Usage<a class="anchor" aria-label="anchor" href="#usage"></a>
</h2>
<p>To create a memory-based cache, call <code><a href="reference/cache_mem.html">cache_mem()</a></code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://cachem.r-lib.org/">cachem</a></span><span class="op">)</span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/cache_mem.html">cache_mem</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Add arbitrary R objects to the cache using <code>$set(key, value)</code>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span><span class="op">$</span><span class="fu">set</span><span class="op">(</span><span class="st">"abc123"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Hello"</span>, <span class="st">"world"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">m</span><span class="op">$</span><span class="fu">set</span><span class="op">(</span><span class="st">"xyz"</span>, <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"Goodbye"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The <code>key</code> must be a string consisting of lowercase letters, numbers, and the underscore (<code>_</code>) and hyphen (<code>-</code>) characters. (Upper-case characters are not allowed because some storage backends do not distinguish between lowercase and uppercase letters.) The <code>value</code> can be any R object.</p>
<p>Get the values with <code>$get()</code>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"abc123"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Hello" "world"</span></span>
<span></span>
<span><span class="va">m</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"xyz"</span><span class="op">)</span></span>
<span><span class="co">#&gt; function() message("Goodbye")</span></span></code></pre></div>
<p>If you call <code><a href="https://rdrr.io/r/base/get.html" class="external-link">get()</a></code> on a key that doesn’t exists, it will return a <code><a href="https://r-lib.github.io/fastmap/reference/key_missing.html" class="external-link">key_missing()</a></code> sentinel value:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"dog"</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;Key Missing&gt;</span></span></code></pre></div>
<p>A common usage pattern is to call <code><a href="https://rdrr.io/r/base/get.html" class="external-link">get()</a></code>, and then check if the result is a <code>key_missing</code> object:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">value</span> <span class="op">&lt;-</span> <span class="va">m</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="va">key</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://r-lib.github.io/fastmap/reference/key_missing.html" class="external-link">is.key_missing</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Cache miss - do something</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="co"># Cache hit - do another thing</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The reason for doing this (instead of calling <code>$exists(key)</code> and then <code>$get(key)</code>) is that for some storage backends, there is a potential race condition: the object could be removed from the cache between the <code><a href="https://rdrr.io/r/base/exists.html" class="external-link">exists()</a></code> and <code><a href="https://rdrr.io/r/base/get.html" class="external-link">get()</a></code> calls. For example:</p>
<ul>
<li>If multiple R processes have <code>cache_disk</code>s that share the same directory, one process could remove an object from the cache in between the <code><a href="https://rdrr.io/r/base/exists.html" class="external-link">exists()</a></code> and <code><a href="https://rdrr.io/r/base/get.html" class="external-link">get()</a></code> calls in another process, resulting in an error.</li>
<li>If you use a <code>cache_mem</code> with a <code>max_age</code>, it’s possible for an object to be present when you call <code><a href="https://rdrr.io/r/base/exists.html" class="external-link">exists()</a></code>, but for its age to exceed <code>max_age</code> by the time <code><a href="https://rdrr.io/r/base/get.html" class="external-link">get()</a></code> is called. In that case, the <code><a href="https://rdrr.io/r/base/get.html" class="external-link">get()</a></code> will return a <code><a href="https://r-lib.github.io/fastmap/reference/key_missing.html" class="external-link">key_missing()</a></code> object.</li>
</ul>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Avoid this pattern, due to a potential race condition!</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="va">m</span><span class="op">$</span><span class="fu">exists</span><span class="op">(</span><span class="va">key</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">value</span> <span class="op">&lt;-</span> <span class="va">m</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="va">key</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="cache-types">Cache types<a class="anchor" aria-label="anchor" href="#cache-types"></a>
</h2>
<p><strong>cachem</strong> comes with two kinds of cache objects: a memory cache, and a disk cache.</p>
<div class="section level3">
<h3 id="cache_mem">
<code>cache_mem()</code><a class="anchor" aria-label="anchor" href="#cache_mem"></a>
</h3>
<p>The memory cache stores stores objects in memory, by simply keeping a reference to each object. To create a memory cache:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/cache_mem.html">cache_mem</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>The default size of the cache is 200MB, but this can be customized with <code>max_size</code>:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/cache_mem.html">cache_mem</a></span><span class="op">(</span>max_size <span class="op">=</span> <span class="fl">10</span> <span class="op">*</span> <span class="fl">1024</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>It may also be useful to set a maximum age of objects. For example, if you only want objects to stay for a maximum of one hour:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/cache_mem.html">cache_mem</a></span><span class="op">(</span>max_size <span class="op">=</span> <span class="fl">10</span> <span class="op">*</span> <span class="fl">1024</span><span class="op">^</span><span class="fl">2</span>, max_age <span class="op">=</span> <span class="fl">3600</span><span class="op">)</span></span></code></pre></div>
<p>For more about how objects are evicted from the cache, see section <a href="#pruning">Pruning</a> below.</p>
<p>An advantage that the memory cache has over the disk cache (and any other type of cache that stores the objects outside of the R process’s memory), is that it does not need to serialize objects. Instead, it merely stores references to the objects. This means that it can store objects that other caches cannot, and with more efficient use of memory – if two objects in the cache share some of their contents (such that they refer to the same sub-object in memory), then <code>cache_mem</code> will not create duplicate copies of the contents, as <code>cache_disk</code> would, since it serializes the objects with the <code><a href="https://rdrr.io/r/base/serialize.html" class="external-link">serialize()</a></code> function.</p>
<p>Compared to the memory usage, the size <em>calculation</em> is not as intelligent: if there are two objects that share contents, their sizes are computed separately, even if they have items that share the exact same represention in memory. This is done with the <code><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size()</a></code> function, which does not account for multiple references to the same object in memory.</p>
<p>In short, a memory cache, if anything, over-counts the amount of memory actually consumed. In practice, this means that if you set a 200MB limit to the size of cache, and the cache <em>thinks</em> it has 200MB of contents, the actual amount of memory consumed could be less than 200MB.</p>
<details><p><summary> Demonstration of memory over-counting from <code>object.size()</code> </summary></p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create a and b which both contain the same numeric vector.</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1e5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">x</span><span class="op">)</span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">2</span>, <span class="va">x</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add to cache</span></span>
<span><span class="va">m</span><span class="op">$</span><span class="fu">set</span><span class="op">(</span><span class="st">"a"</span>, <span class="va">a</span><span class="op">)</span></span>
<span><span class="va">m</span><span class="op">$</span><span class="fu">set</span><span class="op">(</span><span class="st">"b"</span>, <span class="va">b</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Each object is about 800kB in memory, so the cache_mem() will consider the</span></span>
<span><span class="co"># total memory used to be 1600kB.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">m</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"a"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; 800224 bytes</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">m</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"b"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; 800224 bytes</span></span></code></pre></div>
<p>For reference, lobstr::obj_size can detect shared objects, and knows that these objects share most of their memory.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">lobstr</span><span class="fu">::</span><span class="fu">obj_size</span><span class="op">(</span><span class="va">m</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"a"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; 800,224 B</span></span>
<span><span class="fu">lobstr</span><span class="fu">::</span><span class="fu">obj_size</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">m</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"a"</span><span class="op">)</span>, <span class="va">m</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"b"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; 800,408 B</span></span></code></pre></div>
<p>However, lobstr is not on CRAN, and if obj_size() were used to find the incremental memory used when an object was added to the cache, it would have to walk all objects in the cache every time a single object is added. For these reasons, cache_mem uses <code><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size()</a></code> to compute the object sizes.</p></details>
</div>
<div class="section level3">
<h3 id="cache_disk">
<code>cache_disk()</code><a class="anchor" aria-label="anchor" href="#cache_disk"></a>
</h3>
<p>Disk caches are stored in a directory on disk. A disk cache is slower than a memory cache, but can generally be larger. To create one:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/cache_disk.html">cache_disk</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>By default, it creates a subdirectory of the R process’s temp directory, and it will persist until the R process exits.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span><span class="op">$</span><span class="fu">info</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">dir</span></span>
<span><span class="co">#&gt;  "/tmp/Rtmp6h5iB3/cache_disk-d1901b2b615a"</span></span></code></pre></div>
<p>Like a <code>cache_mem</code>, the <code>max_size</code>, <code>max_n</code>, <code>max_age</code> can be customized. See section <a href="#pruning">Pruning</a> below for more information.</p>
<p>Each object in the cache is stored as an RDS file on disk, using the <code><a href="https://rdrr.io/r/base/serialize.html" class="external-link">serialize()</a></code> function.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span><span class="op">$</span><span class="fu">set</span><span class="op">(</span><span class="st">"abc"</span>, <span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">d</span><span class="op">$</span><span class="fu">set</span><span class="op">(</span><span class="st">"x01"</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="fu">info</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">dir</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "abc.rds" "x01.rds"</span></span></code></pre></div>
<p>Since objects in a disk cache are serialized, they are subject to the limitations of the <code><a href="https://rdrr.io/r/base/serialize.html" class="external-link">serialize()</a></code> function. For more information, see section <a href="#limitations-of-serialized-objects">Limitations of serialized objects</a>.</p>
<p>The storage directory can be specified with <code>dir</code>; it will be created if necessary.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/cache_disk.html">cache_disk</a></span><span class="op">(</span>dir <span class="op">=</span> <span class="st">"cachedir"</span><span class="op">)</span></span></code></pre></div>
<div class="section level4">
<h4 id="sharing-a-disk-cache-among-processes">Sharing a disk cache among processes<a class="anchor" aria-label="anchor" href="#sharing-a-disk-cache-among-processes"></a>
</h4>
<p>Multiple R processes can use <code>disk_cache</code> objects that share the same cache directory. To do this, simply point each <code>cache_disk</code> to the same directory.</p>
</div>
<div class="section level4">
<h4 id="disk_cache-pruning">
<code>disk_cache</code> pruning<a class="anchor" aria-label="anchor" href="#disk_cache-pruning"></a>
</h4>
<p>For a <code>disk_cache</code>, pruning does not happen on every access, because finding the size of files in the cache directory can take a nontrivial amount of time. By default, pruning happens once every 20 times that <code>$set()</code> is called, or if at least five seconds have elapsed since the last pruning. The <code>prune_rate</code> controls how many times <code>$set()</code> must be called before a pruning occurs. It defaults to 20; smaller values result in more frequent pruning and larger values result in less frequent pruning (but keep in mind pruning always occurs if it has been at least five seconds since the last pruning).</p>
</div>
<div class="section level4">
<h4 id="cleaning-up-the-cache-directory">Cleaning up the cache directory<a class="anchor" aria-label="anchor" href="#cleaning-up-the-cache-directory"></a>
</h4>
<p>The cache directory can be deleted by calling <code>$destroy()</code>. After it is destroyed, the cache object can no longer be used.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span><span class="op">$</span><span class="fu">destroy</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">d</span><span class="op">$</span><span class="fu">set</span><span class="op">(</span><span class="st">"a"</span>, <span class="fl">1</span><span class="op">)</span>  <span class="co"># Error</span></span></code></pre></div>
<p>To create a <code>cache_disk</code> that will automatically delete its storage directory when garbage collected, use <code>destroy_on_finalize=TRUE</code>:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/cache_disk.html">cache_disk</a></span><span class="op">(</span>destroy_on_finalize <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">d</span><span class="op">$</span><span class="fu">set</span><span class="op">(</span><span class="st">"a"</span>, <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cachedir</span> <span class="op">&lt;-</span> <span class="va">d</span><span class="op">$</span><span class="fu">info</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">dir</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span><span class="va">cachedir</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "a.rds"</span></span>
<span></span>
<span><span class="co"># Remove reference to d and trigger a garbage collection</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/gc.html" class="external-link">gc</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.exists</a></span><span class="op">(</span><span class="va">cachedir</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="using-custom-serialization-functions">Using custom serialization functions<a class="anchor" aria-label="anchor" href="#using-custom-serialization-functions"></a>
</h4>
<p>It is possible to use custom serialization functions rather than the default of <code>writeRDS()</code> and <code><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS()</a></code> with the <code>write_fn</code>, <code>read_fn</code> and <code>extension</code> arguments respectively. This could be used to use alternative serialization formats like <a href="https://github.com/traversc/qs" class="external-link">qs</a>, or specialized object formats <a href="http://www.fstpackage.org/fst/" class="external-link">fst</a> or parquet.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/traversc/qs" class="external-link">qs</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; qs v0.25.3.</span></span>
<span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/cache_disk.html">cache_disk</a></span><span class="op">(</span>read_fn <span class="op">=</span> <span class="fu">qs</span><span class="fu">::</span><span class="va">qread</span>, write_fn <span class="op">=</span> <span class="fu">qs</span><span class="fu">::</span><span class="va">qsave</span>, extension <span class="op">=</span> <span class="st">".qs"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">d</span><span class="op">$</span><span class="fu">set</span><span class="op">(</span><span class="st">"a"</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cachedir</span> <span class="op">&lt;-</span> <span class="va">d</span><span class="op">$</span><span class="fu">info</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">dir</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span><span class="va">cachedir</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "a.qs"</span></span>
<span><span class="va">d</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"a"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; [1] 2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[3]]</span></span>
<span><span class="co">#&gt; [1] 3</span></span></code></pre></div>
</div>
</div>
</div>
<div class="section level2">
<h2 id="cache-api">Cache API<a class="anchor" aria-label="anchor" href="#cache-api"></a>
</h2>
<p><code><a href="reference/cache_mem.html">cache_mem()</a></code> and <code><a href="reference/cache_disk.html">cache_disk()</a></code> support all of the methods listed below. If you want to create a compatible caching object, it must have at least the <code><a href="https://rdrr.io/r/base/get.html" class="external-link">get()</a></code> and <code>set()</code> methods:</p>
<ul>
<li>
<code>get(key, missing = missing_)</code>: Get the object associated with <code>key</code>. The <code>missing</code> parameter allows customized behavior if the key is not present: it actually is an expression which is evaluated when there is a cache miss, and it could return a value or throw an error.</li>
<li>
<code>set(key, value)</code>: Set a key to a value.</li>
<li>
<code>exists(key)</code>: Check whether a particular key exists in the cache.</li>
<li>
<code>remove(key)</code>: Remove a key-value from the cache.</li>
</ul>
<p>Some optional methods:</p>
<ul>
<li>
<code>reset()</code>: Clear all objects from the cache.</li>
<li>
<code>keys()</code>: Return a character vector of all keys in the cache.</li>
<li>
<code>prune()</code>: Prune the cache. (Some types of caches may not prune on every access, and may temporarily grow past their limits, until the next pruning is triggered automatically, or manually with this function.)</li>
<li>
<code>size()</code>: Return the number of objects in the cache.</li>
<li>
<code>size()</code>: Return the number of objects in the cache.</li>
</ul>
<p>For these methods:</p>
<ul>
<li>
<code>key</code>: can be any string with lowercase letters, numbers, underscore (<code>_</code>) and hyphen (<code>-</code>). Some storage backends may not be handle very long keys well. For example, with a <code><a href="reference/cache_disk.html">cache_disk()</a></code>, the key is used as a filename, and on some filesystems, very filenames may hit limits on path lengths.</li>
<li>
<code>value</code>: can be any R object, with some exceptions noted below.</li>
</ul>
<div class="section level4">
<h4 id="limitations-of-serialized-objects">Limitations of serialized objects<a class="anchor" aria-label="anchor" href="#limitations-of-serialized-objects"></a>
</h4>
<p>For any cache that serializes the object for storage outside of the R process – in other words, any cache other than a <code><a href="reference/cache_mem.html">cache_mem()</a></code> – some types of objects will not save and restore as well. Notably, reference objects may consume more memory when restored, since R may not know to deduplicate shared objects. External pointers are not be able to be serialized, since they point to memory in the R process. See <code><a href="https://rdrr.io/r/base/serialize.html" class="external-link">?serialize</a></code> for more information.</p>
</div>
<div class="section level4">
<h4 id="read-only-caches">Read-only caches<a class="anchor" aria-label="anchor" href="#read-only-caches"></a>
</h4>
<p>It is possible to create a read-only cache by making the <code>set()</code>, <code><a href="https://rdrr.io/r/base/rm.html" class="external-link">remove()</a></code>, <code>reset()</code>, and <code>prune()</code> methods into no-ops. This can be useful if sharing a cache with another R process which can write to the cache. For example, one (or more) processes can write to the cache, and other processes can read from it.</p>
<p>This function will wrap a cache object in a read-only wrapper. Note, however, that code that uses such a cache must not require that <code>$set()</code> actually sets a value in the cache. This is good practice anyway, because with these cache objects, items can be pruned from them at any time.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cache_readonly_wrap</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">cache</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/structure.html" class="external-link">structure</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      get <span class="op">=</span> <span class="va">cache</span><span class="op">$</span><span class="va">get</span>,</span>
<span>      set <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">key</span>, <span class="va">value</span><span class="op">)</span> <span class="cn">NULL</span>,</span>
<span>      exists <span class="op">=</span> <span class="va">cache</span><span class="op">$</span><span class="va">exists</span>,</span>
<span>      keys <span class="op">=</span> <span class="va">cache</span><span class="op">$</span><span class="va">keys</span>,</span>
<span>      remove <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">key</span><span class="op">)</span> <span class="cn">NULL</span>,</span>
<span>      reset <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="cn">NULL</span>,</span>
<span>      prune <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="cn">NULL</span>,</span>
<span>      size <span class="op">=</span> <span class="va">cache</span><span class="op">$</span><span class="va">size</span></span>
<span>    <span class="op">)</span>,</span>
<span>    class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cache_readonly"</span>, <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">cache</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">mr</span> <span class="op">&lt;-</span> <span class="fu">cache_readonly_wrap</span><span class="op">(</span><span class="va">m</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="pruning">Pruning<a class="anchor" aria-label="anchor" href="#pruning"></a>
</h2>
<p>The cache objects provided by cachem have automatic pruning. (Note that pruning is not required by the API, so one could implement an API-compatible cache without pruning.)</p>
<p>This section describes how pruning works for <code><a href="reference/cache_mem.html">cache_mem()</a></code> and <code><a href="reference/cache_disk.html">cache_disk()</a></code>.</p>
<p>When the cache object is created, the maximum size (in bytes) is specified by <code>max_size</code>. When the size of objects in the cache exceeds <code>max_size</code>, objects will be pruned from the cache.</p>
<p>When objects are pruned from the cache, which ones are removed is determined by the eviction policy, <code>evict</code>:</p>
<ul>
<li>
<strong><code>lru</code></strong>: The least-recently-used objects will be removed from the cache, until it fits within the limit. This is the default and is appropriate for most cases.</li>
<li>
<strong><code>fifo</code></strong>: The oldest objects will be removed first.</li>
</ul>
<p>It is also possible to set the maximum number of items that can be in the cache, with <code>max_n</code>. By default this is set to <code>Inf</code>, or no limit.</p>
<p>The <code>max_age</code> parameter is somewhat different from <code>max_size</code> and <code>max_n</code>. The latter two set limits on the cache store as a whole, whereas <code>max_age</code> sets limits for each individual item; for each item, if its age exceeds <code>max_age</code>, then it will be removed from the cache.</p>
</div>
<div class="section level2">
<h2 id="layered-caches">Layered caches<a class="anchor" aria-label="anchor" href="#layered-caches"></a>
</h2>
<p>Multiple caches can be composed into a single cache, using <code><a href="reference/cache_layered.html">cache_layered()</a></code>. This can be used to create a multi-level cache. (Note thate <code><a href="reference/cache_layered.html">cache_layered()</a></code> is currently experimental.) For example, we can create a layered cache with a very fast 100MB memory cache and a larger but slower 2GB disk cache:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/cache_mem.html">cache_mem</a></span><span class="op">(</span>max_size <span class="op">=</span> <span class="fl">100</span> <span class="op">*</span> <span class="fl">1024</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/cache_disk.html">cache_disk</a></span><span class="op">(</span>max_size <span class="op">=</span> <span class="fl">2</span> <span class="op">*</span> <span class="fl">1024</span><span class="op">^</span><span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/cache_layered.html">cache_layered</a></span><span class="op">(</span><span class="va">m</span>, <span class="va">d</span><span class="op">)</span></span></code></pre></div>
<p>The layered cache will have the same API, with <code>$get()</code>, <code>$set()</code>, and so on, so it can be used interchangeably with other caching objects.</p>
<p>For this example, we’ll recreate the <code>cache_layered</code> with logging enabled, so that it will show cache hits and misses.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/cache_layered.html">cache_layered</a></span><span class="op">(</span><span class="va">m</span>, <span class="va">d</span>, logfile <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/showConnections.html" class="external-link">stderr</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Each of the objects generated by rnorm() is about 40 MB</span></span>
<span><span class="va">cl</span><span class="op">$</span><span class="fu">set</span><span class="op">(</span><span class="st">"a"</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">5e6</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cl</span><span class="op">$</span><span class="fu">set</span><span class="op">(</span><span class="st">"b"</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">5e6</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cl</span><span class="op">$</span><span class="fu">set</span><span class="op">(</span><span class="st">"c"</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">5e6</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># View the objects in each of the component caches</span></span>
<span><span class="va">m</span><span class="op">$</span><span class="fu">keys</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "c" "b"</span></span>
<span><span class="va">d</span><span class="op">$</span><span class="fu">keys</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "a" "b" "c"</span></span>
<span></span>
<span><span class="co"># The layered cache reports having all keys</span></span>
<span><span class="va">cl</span><span class="op">$</span><span class="fu">keys</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "c" "b" "a"</span></span></code></pre></div>
<p>When <code>$get()</code> is called, it searches the first cache, and if it’s missing there, it searches the next cache, and so on. If not found in any caches, it returns <code><a href="https://r-lib.github.io/fastmap/reference/key_missing.html" class="external-link">key_missing()</a></code>.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get object that exists in the memory cache</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">cl</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"c"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [2020-10-23 13:11:09.985] cache_layered Get: c</span></span>
<span><span class="co">#&gt; [2020-10-23 13:11:09.985] cache_layered Get from cache_mem... hit</span></span>
<span></span>
<span><span class="co"># Get object that doesn't exist in the memory cache</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">cl</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"a"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [2020-10-23 13:13:10.968] cache_layered Get: a</span></span>
<span><span class="co">#&gt; [2020-10-23 13:13:10.969] cache_layered Get from cache_mem... miss</span></span>
<span><span class="co">#&gt; [2020-10-23 13:13:11.329] cache_layered Get from cache_disk... hit</span></span>
<span></span>
<span><span class="co"># Object is not present in any component caches</span></span>
<span><span class="va">cl</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"d"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [2020-10-23 13:13:40.197] cache_layered Get: d</span></span>
<span><span class="co">#&gt; [2020-10-23 13:13:40.197] cache_layered Get from cache_mem... miss</span></span>
<span><span class="co">#&gt; [2020-10-23 13:13:40.198] cache_layered Get from cache_disk... miss</span></span>
<span><span class="co">#&gt; &lt;Key Missing&gt;</span></span></code></pre></div>
<p>Multiple cache objects can be layered this way. You could even add a cache which uses a remote store, such as a network file system or even AWS S3.</p>
</div>
</div>

  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://cloud.r-project.org/package=cachem" class="external-link">View on CRAN</a></li>
<li><a href="https://github.com/r-lib/cachem/" class="external-link">Browse source code</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php" class="external-link">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing cachem</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Winston Chang <br><small class="roles"> Author, maintainer </small>  </li>
<li> RStudio <br><small class="roles"> Copyright holder, funder </small>  </li>
</ul>
</div>

<div class="dev-status">
<h2 data-toc-skip>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/r-lib/cachem/actions" class="external-link"><img src="https://github.com/r-lib/cachem/actions/workflows/R-CMD-check.yaml/badge.svg" alt="R build status"></a></li>
</ul>
</div>

  </div>
</div>


      <footer><div class="copyright">
  <p></p>
<p>Developed by Winston Chang, RStudio.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
